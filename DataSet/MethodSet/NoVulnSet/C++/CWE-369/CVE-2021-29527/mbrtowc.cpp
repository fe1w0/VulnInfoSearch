r sorting this all out is done before this function,
    // when we calculate the output size, but