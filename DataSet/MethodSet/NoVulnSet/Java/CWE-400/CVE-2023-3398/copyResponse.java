public class ProxyServlet extends HttpServlet
{
	public static final Logger log = Logger
	public static int BUFFER_SIZE = 3 * 1024;
	public static final int TIMEOUT = 29000;
	public static int MAX_FETCH_SIZE = 50 * 1024 * 1024; // 50 MB
	public static byte[] emptyBytes = new byte[0];
	public void copyResponse(InputStream is, OutputStream out, byte[] head,
			boolean base64) throws IOException
	{
		if (base64)
		{
			int total = 0;

			try (BufferedInputStream in = new BufferedInputStream(is,
					BUFFER_SIZE))
			{
				ByteArrayOutputStream os = new ByteArrayOutputStream();
			    byte[] buffer = new byte[0xFFFF];

				os.write(head, 0, head.length);
				
			    for (int len = is.read(buffer); len != -1; len = is.read(buffer))
			    {
					total += len;

					if (total > MAX_FETCH_SIZE)
					{
						throw new IOException("Size limit exceeded");
					}

			        os.write(buffer, 0, len);
			    }

				out.write(mxBase64.encodeToString(os.toByteArray(), false).getBytes());
			}
		}
		else
		{
			out.write(head);
			Utils.copyRestricted(is, out, MAX_FETCH_SIZE);
		}
	}
}