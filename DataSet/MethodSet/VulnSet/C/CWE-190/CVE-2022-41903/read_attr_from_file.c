static struct attr_stack *read_attr_from_file(const char *path, unsigned flags)
{
	int fd;
	FILE *fp;
	struct attr_stack *res;
	char buf[2048];
	int lineno = 0;

	if (flags & READ_ATTR_NOFOLLOW)
		fd = open_nofollow(path, O_RDONLY);
	else
		fd = open(path, O_RDONLY);

	if (fd < 0) {
		warn_on_fopen_errors(path);
		return NULL;
	}
	fp = xfdopen(fd, "r");

	CALLOC_ARRAY(res, 1);
	while (fgets(buf, sizeof(buf), fp)) {
		char *bufp = buf;
		if (!lineno)
			skip_utf8_bom(&bufp, strlen(bufp));
		handle_attr_line(res, bufp, path, ++lineno, flags);
	}
	fclose(fp);
	return res;
}