   // Most of the logic for sorting this all out is done before this f;