cute the calc function in the innermost iteration based on the shape of
// the output. The calc function shou