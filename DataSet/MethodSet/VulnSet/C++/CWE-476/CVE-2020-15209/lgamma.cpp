r is resized.
      // We don't have to prepare all the ops, but we need to recompute
      // the allocation pla