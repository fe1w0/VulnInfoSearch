public class InMemoryConnectionStore implements ResumptionSupportingConnectionStore, CloseSupportingConnectionStore {
	private static final Logger LOG = LoggerFactory.getLogger(InMemoryConnectionStore.class);
	private static final int DEFAULT_SMALL_EXTRA_CID_LENGTH = 2; // extra cid bytes additionally to required bytes for small capacity.
	private static final int DEFAULT_LARGE_EXTRA_CID_LENGTH = 3; // extra cid bytes additionally to required bytes for large capacity.
	private static final int DEFAULT_CACHE_SIZE = 150000;
	private static final long DEFAULT_EXPIRATION_THRESHOLD = 36 * 60 * 60; // 36h
	private final SessionCache sessionCache;
	protected final LeastRecentlyUsedCache<ConnectionId, Connection> connections;
	protected final ConcurrentMap<InetSocketAddress, Connection> connectionsByAddress;
	protected final ConcurrentMap<SessionId, Connection> connectionsByEstablishedSession;
	private ConnectionListener connectionListener;
	private ConnectionIdGenerator connectionIdGenerator;
	protected String tag = "";
	public synchronized boolean remove(final Connection connection, final boolean removeFromSessionCache) {
		boolean removed = connections.remove(connection.getConnectionId(), connection) == connection;
		if (removed) {
			List<Runnable> pendings = connection.getExecutor().shutdownNow();
			if (LOG.isTraceEnabled()) {
				LOG.trace("{}connection: remove {} (size {}, left jobs: {})", tag, connection, connections.size(),
						pendings.size(), new Throwable("connection removed!"));
			} else if (pendings.isEmpty()) {
				LOG.debug("{}connection: remove {} (size {})", tag, connection, connections.size());
			} else {
				LOG.debug("{}connection: remove {} (size {}, left jobs: {})", tag, connection, connections.size(),
						pendings.size());
			}
			removeFromEstablishedSessions(connection);
			removeFromAddressConnections(connection);
			if (removeFromSessionCache) {
				removeSessionFromCache(connection);
			}
			ConnectionListener listener = connectionListener;
			if (listener != null) {
				listener.onConnectionRemoved(connection);
			}
		}
		return removed;
	}
}