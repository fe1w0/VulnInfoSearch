user_id = self.register_user('kermit', 'test')
tok = self.login('kermit', 'test')
room_id = self.helper.create_room_as(room_creator=user_id, tok=tok)
invite_token = 'sometoken'
self.helper.send_state(room_id=room_id, event_type=EventTypes.ThirdPartyInvite, state_key=invite_token, body={}, tok=tok)
d = self.handler.on_exchange_third_party_invite_request(room_id=room_id, event_dict={'type': EventTypes.Member, 'room_id': room_id, 'sender': user_id, 'state_key': '@someone:example.org', 'content': {'membership': 'invite', 'third_party_invite': {'display_name': 'alice', 'signed': {'mxid': '@alice:localhost', 'token': invite_token, 'signatures': {'magic.forest': {'ed25519:3': 'fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg'}}}}}})
failure = self.get_failure(d, AuthError).value
self.assertEqual(failure.code, 403, failure)
self.assertEqual(failure.errcode, Codes.FORBIDDEN, failure)
self.assertEqual(failure.msg, 'You are not invited to this room.')